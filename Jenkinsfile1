pipeline{
    agent any
    environment {
        registry = "rasbarbies/vproappdock"
        registryCredential = 'docker-hub-credentials-id'
    }

    /*agent {
        label 'KOPS'
    }  */

    

    stages{
        stage('BUILD') {
            steps {
                sh 'mvn clean package'
            }
        }
        stage('UNIT TEST'){
            steps {
                sh 'mvn test'
            }
        }
        stage("SONAR QUALITY CHECK") {
            steps {
                script {
                  withSonarQubeEnv(installationName: 'sonarscanner', credentialsId:'kube-sonar-token'){
                   sh 'mvn sonar:sonar'
              }
            }
        }
        }


        stage('BUILD APP IMAGE') {
          steps {
            script {
              dockerImage = docker.build registry + ":V$BUILD_NUMBER"
              }
            }

           }
        stage('UPLOAD IMAGE') {
          steps {
            script {
               docker.withRegistry('https://registry.hub.docker.com', registryCredential) {
                 dockerImage.push("V$BUILD_NUMBER")
                   dockerImage.push('latest')
               }
            }
          }
         }
        stage('REMOVE UNUSED DOCKER IMAGE') {
          steps{
            sh "docker rmi $registry:V$BUILD_NUMBER"
            }
          }

        stage('KUBERNETES DEPLOY') {
          agent {label 'KOPS'}
            steps {
            script {
              sh '''kubectl apply -f springboot-deployment.yml  
                  kubectl apply -f springboot-service.yaml
                  kubectl get all
                '''
        }
        }
        }
    }
}